# مشروع إدارة مشاريع البناء العربي
Arabic Construction Project Management System

## نظرة عامة على المشروع
تطبيق ويب شامل لإدارة مشاريع البناء باللغة العربية، يوفر أدوات قوية لتتبع المصاريف وإدارة العمال وإعداد التقارير التفصيلية مع تركيز على واجهة عربية دقيقة وتصميم متجاوب.

## المكونات الرئيسية
- **إدارة المشاريع**: إنشاء وتتبع مشاريع البناء المتعددة
- **إدارة العمال**: نظام شامل لتسجيل العمال وحضورهم وأجورهم
- **تتبع المصاريف**: تسجيل مفصل لجميع أنواع المصاريف
- **نظام التقارير**: تقارير مالية شاملة وكشوف حسابات مفصلة
- **نظام الإكمال التلقائي**: اقتراحات ذكية مبنية على الاستخدام السابق

## التحسينات الأخيرة (أغسطس 2025)

### تحسين نظام الإكمال التلقائي
تم تطبيق تحسينات شاملة على نظام الإكمال التلقائي بناءً على تحليل شامل للأداء والتوصيات المقترحة:

### تحسينات الأداء المتقدمة (أغسطس 2025)
تم تطبيق حلول متقدمة لمعالجة البطء في عمليات INSERT و DELETE:

#### الحلول المطبقة:
1. **فهارس قاعدة البيانات المحسنة**:
   - `idx_autocomplete_category_usage`: لتحسين البحث والترتيب
   - `idx_autocomplete_value_search`: للبحث النصي السريع
   - `idx_autocomplete_cleanup`: لعمليات التنظيف
   - `idx_autocomplete_stats`: لإحصائيات النظام

2. **نظام تنظيف دوري ذكي**:
   - حذف تلقائي للبيانات القديمة (أكثر من 6 أشهر وأقل من 3 استخدامات)
   - صيانة يومية مجدولة
   - صيانة أسبوعية شاملة

3. **حدود ذكية للبيانات**:
   - حد أقصى 100 اقتراح لكل فئة
   - حذف تلقائي للاقتراحات الأقل استخداماً

4. **واجهة إدارية متقدمة**:
   - إحصائيات مفصلة للنظام
   - أدوات صيانة يدوية
   - مراقبة صحة النظام

#### الملفات المضافة:
- `server/autocomplete-optimizer.ts`: محرك التحسين والتنظيف
- `server/autocomplete-scheduler.ts`: جدولة المهام الدورية
- `server/db/run-autocomplete-migrations.ts`: نقل فهارس قاعدة البيانات
- `client/src/pages/autocomplete-admin.tsx`: واجهة الإدارة
- `server/batch-operations-optimizer.ts`: محسن العمليات الجماعية
- `server/materialized-view-manager.ts`: مدير العروض المادية
- `server/database-performance-analyzer.ts`: محلل أداء قاعدة البيانات المتقدم

#### التحسينات في الأداء:
- تحسين استعلامات قاعدة البيانات بفهارس محسنة
- تقليل استهلاك الذاكرة عبر التنظيف الدوري
- تسريع زمن الاستجابة (هدف أقل من 100ms)

#### حلول الأداء المتقدمة المطبقة:
1. **العمليات الجماعية (Batch Operations)**:
   - حذف جماعي محسن للمئات من السجلات دفعة واحدة
   - إدخال جماعي مع معالجة التكرار
   - عمليات مقسمة للكميات الكبيرة (+100 سجل)
   - fallback للعمليات الفردية عند الحاجة

2. **العروض المادية (Materialized Views)**:
   - view للملخص اليومي بدلاً من triggers مباشرة
   - view لإحصائيات الإكمال التلقائي
   - تحديث متزامن مجدول كل 6 ساعات
   - فهارس محسنة على العروض المادية

3. **تحسينات قاعدة البيانات**:
   - VACUUM تلقائي بعد العمليات الكبيرة
   - مراقبة أحجام الجداول والفهارس
   - كشف المشاكل الحرجة تلقائياً

## التكنولوجيات المستخدمة
- **Frontend**: React.js، TypeScript، Tailwind CSS
- **Backend**: Node.js، Express.js
- **Database**: Supabase PostgreSQL
- **ORM**: Drizzle ORM
- **State Management**: TanStack Query
- **Routing**: Wouter

## تفضيلات المستخدم
- اللغة الأساسية: العربية
- الاتجاه: من اليمين لليسار (RTL)
- التركيز على البساطة والوضوح في الواجهة
- التحسين المستمر للأداء
- **التواصل**: جميع الردود والملاحظات يجب أن تكون باللغة العربية (محدث في 2 أغسطس 2025)

## القرارات التقنية الأخيرة
- تطبيق الحل الأول لتحسين نظام الإكمال التلقائي (Solution 1)
- التركيز على تحسين النظام الحالي بدلاً من إعادة بنائه
- استخدام صيانة دورية مجدولة لضمان الأداء المستمر
- إضافة واجهة إدارية لمراقبة النظام

## الأهداف المستقبلية
- مراقبة أداء النظام المحسن وقياس التحسينات
- تطبيق نظام هجين إذا تطلب الأمر (عند نمو البيانات)
- إضافة ميزات ذكاء اصطناعي للاقتراحات المحسنة
- تحسين تجربة المستخدم بناءً على الاستخدام الفعلي

## ملاحظات التطوير
- جميع التحديثات تتم مع مراعاة التوافق العكسي
- التركيز على سلامة البيانات وعدم فقدانها
- اختبار شامل قبل تطبيق أي تغييرات على قاعدة البيانات
- توثيق جميع التغييرات بالتفصيل

## إصلاحات أغسطس 2025 - إحصائيات المشاريع

### مشكلة حساب الرصيد المتبقي (2 أغسطس 2025)
تم اكتشاف وإصلاح مشكلة خطيرة في حساب إحصائيات المشاريع:

#### المشكلة الأصلية:
- الإحصائيات تظهر إجمالي دخل ومصروفات غير صحيحة
- الرصيد المتبقي لا يطابق الحسابات الفعلية
- عدم مراعاة المبالغ المرحلة من الأيام السابقة

#### الحل المطبق:
1. **استخدام آخر ملخص يومي كمرجع أساسي**:
   - الملخص اليومي يحتوي على الحسابات الصحيحة مع المبلغ المرحل
   - يشمل جميع أنواع المصروفات والدخل بشكل متراكم

2. **تحسين دالة getProjectStatistics**:
   - إزالة الحساب المباشر من البيانات الخام
   - الاعتماد على الملخص اليومي الأحدث
   - إضافة fallback للمشاريع بدون ملخصات يومية

3. **تحسين سجلات التشخيص**:
   - إضافة تفاصيل واضحة عن مصدر البيانات
   - مقارنة بين الطرق المختلفة للحساب
   - تحديد نوع البيانات المستخدمة

#### النتائج:
- ✅ إصلاح دقة حساب الرصيد المتبقي (24,200 ريال)
- ✅ إحصائيات صحيحة لإجمالي الدخل والمصروفات
- ✅ مراعاة المبالغ المرحلة من الأيام السابقة
- ✅ حماية من الأخطاء المحاسبية المستقبلية
- ✅ تطبيق الحل النهائي واختباره بنجاح (2 أغسطس 2025)

## إضافة التقارير المتقدمة (أغسطس 2025)

### نظام التقارير المتقدم الجديد
تم إنشاء نظام تقارير احترافي شامل يتضمن:

#### الميزات الأساسية:
1. **اختيار نوع التقرير**: مصروفات أو إيرادات
2. **تحديد المشروع والفترة الزمنية**: من تاريخ إلى تاريخ
3. **تقارير المصروفات الشاملة**:
   - جميع المصروفات اليومية العامة
   - أجور العمال وحضورهم
   - مشتريات المواد والمعدات
   - تحويلات العمال
   - تصنيف حسب الفئات (عمالة، نثريات، مشتريات، أجور، مواصلات، مهندسين)

4. **تقارير الإيرادات**:
   - تحويلات العهدة
   - رقم الحوالة واسم المرسل
   - نوع الحوالة والتاريخ

#### المخرجات الاحترافية:
- **جداول تفاعلية**: تصميم احترافي مع فلترة وترتيب
- **إجماليات تلقائية**: حساب الإجماليات لكل فئة والإجمالي العام
- **تصدير Excel**: تصدير كامل مع التنسيق والعناوين
- **طباعة**: تخطيط محسن للطباعة
- **تصميم متجاوب**: يعمل على جميع الأجهزة

#### الملفات المضافة:
- `client/src/pages/advanced-reports.tsx`: الواجهة الرئيسية
- `server/storage.ts`: دوال `getExpensesForReport` و `getIncomeForReport`
- `server/routes.ts`: مسار API `/api/reports/advanced`

#### المسار:
- متاح عبر `/advanced-reports` في التطبيق
- مدمج في نظام التنقل الأساسي

## حالة المشروع الحالية
✅ نظام الإكمال التلقائي محسن ويعمل بكفاءة عالية
✅ فهارس قاعدة البيانات مطبقة
✅ نظام التنظيف الدوري نشط
✅ واجهة الإدارة متاحة للمراقبة والصيانة
✅ إحصائيات المشاريع تعمل بدقة عالية ومحاسبة صحيحة
✅ التقارير المتقدمة الاحترافية متاحة مع تصدير Excel وطباعة
✅ جميع الأنظمة الأساسية تعمل بشكل مثالي