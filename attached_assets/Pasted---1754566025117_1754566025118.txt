 والمبالغ المتبقية للعمال. دعني أفحص الكود فوراً وأصلح هذه المشكلة الحسابية.

من الصور أرى:

العامل نجيب: تم تحويل 10,000 ريال له لكن النظام يظهر أن رصيده المتبقي 6,000 ريال
هناك تضارب في الحسابات
دعني أفحص كود حساب أرصدة العمال:


Searched for "البحث عن الكود المسؤول عن حساب أرصدة العمال وكيفية حساب المبالغ المتبقية والمحولة لهم"
دعني أفحص ملفات حساب العمال الفعلية:


Searched for "البحث عن ملفات كشف حساب العمال وحساب الأرصدة"
دعني أفحص كود حساب أرصدة العمال في الـ backend:


Searched for ""
وجدت المشكلة! هناك خطأ في منطق حساب الرصيد. دعني أفحص المنطق بدقة:

في الكود الحالي:

currentBalance = totalEarned - totalPaid - totalTransferred
هذا خطأ! المنطق الصحيح يجب أن يكون:

إذا تم تحويل مال للعامل، فهذا يزيد رصيده (إيجابي)
إذا تم دفع أجر للعامل من حسابه، فهذا ينقص رصيده
إذا تم تحويل مال من حساب العامل للأهل، فهذا ينقص رصيده
الصيغة الصحيحة:

currentBalance = totalEarned + totalTransferredToWorker - totalPaid - totalTransferredFromWorker
دعني أفحص بيانات العامل "نجيب" لأفهم التفاصيل:


Executed curl -s "http://localhost:5000/api/workers/f31a953e-a2dc-4226-9b31-af1d2e8a5991/account-statement?dateFrom=2025-07-01&dateTo=2025-08-31" | head -200
الآن فهمت المشكلة بالضبط! دعني أحلل البيانات:

للعامل نجيب:

إجمالي المكتسب من العمل: 48,000 ريال (مجموع dailyWage من سجلات الحضور)
إجمالي المدفوع له: 38,000 ريال (مجموع paidAmount)
التحويل: 10,000 ريال تم تحويله إلى العامل (ليس منه)
المشكلة في الكود:
الكود يتعامل مع التحويلات كأنها تنقص من رصيد العامل، لكن هذا التحويل يزيد رصيده لأنه تحويل إليه وليس منه.

دعني أصلح الكود فوراً:


Opened server/storage.ts
وجدت الخطأ! في السطر 1093، المنطق خاطئ. هذا التحويل هو إلى العامل وليس من العامل، لذلك يجب أن يُضاف إلى رصيده وليس أن يُطرح.

دعني أصلح هذا الخطأ الخطير:


Edited server/storage.ts
-1
+3
-1
+3
      totalTransferred += parseFloat(transfer.amount || '0');
    });
    
    const currentBalance = totalEarned - totalPaid - totalTransferred;
    // الرصيد = المكتسب + التحويلات الواردة - المدفوع
    // التحويلات في هذا الجدول هي تحويلات إلى العامل (واردة) وليس منه
    const currentBalance = totalEarned + totalTransferred - totalPaid;
    
    const balance: WorkerBalance = {
      id: `${workerId}-${projectId}`,
الآن دعني أفحص إذا كان نفس الخطأ موجود في ملف storage-broken.ts:


Searched for "البحث عن نفس الخطأ في ملف storage-broken.ts في حساب أرصدة العمال"
الآن دعني أتحقق من صفحة العامل في Frontend لأرى إذا كان نفس الخطأ موجود هناك:


Searched for "البحث عن ملف صفحة حساب العامل في Frontend وكيفية حساب الرصيد الحالي"
دعني أبحث عن صفحة حساب العامل الفعلية:

just now
Correctly calculate remaining balance for workers
Screenshot
Load preview
2 minutes of work

Scroll to latest
This chat has ende