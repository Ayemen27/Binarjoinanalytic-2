إليك ملخص المشكلة، وأصلها، والخطوات المقترحة لحلها:


---

1. المشكلة

بعض حقول الإدخال في صفحة «المصاريف اليومية» لا تُخزَّن قيمها في جدول autocomplete_data بعد الضغط على زر “إضافة” أو “حفظ”، رغم أن هذه القيم تظهر وتُحفظ في الجدول الرئيسي (مثل fund_transfers). الحقول المتأثّرة هي:

senderNames

transferNumbers

transportDescriptions

notes


بينما حقل workerMiscDescriptions يعمل بشكل طبيعي ويُحدّث جدول الـ autocomplete.


---

2. السبب الجذري

عند إضافة أو تعديل سجل جديد عبر الزر، يتم إرسال البيانات إلى الـ API الخاص بالجدول الرئيسي، ولكن لا توجد استدعاءات إضافية لإضافة القيمة المدخلة حديثاً إلى جدول autocomplete_data. نظام الإكمال التلقائي يعتمد فقط على:

1. اختيار قيمة من القائمة المنسدلة (handleSelect).


2. الخروج من الحقل (handleBlur).


3. الضغط على Enter (handleKeyDown).



لذلك، عندما يتم الإدخال ثم الضغط على الزر مباشرةً، لا يتم تفعيل أيّ من هذه المُعالجات التي تضيف القيمة إلى الـ autocomplete.


---

3. طريقة الحل

1. إنشاء دالة مساعدة (Helper) مخصّصة لإرسال القيمة إلى الـ API الخاص بجدول autocomplete_data بعد نجاح المعاملة الرئيسية:

async function saveAutocompleteValue(field: string, value: string) {
  if (!value) return;
  await api.post('/autocomplete', { field, value });
}


2. تعديل معالجات الـ mutations في صفحة المصاريف لتستدعي هذه الدالة في حدث onSuccess لكل عملية إنشاء أو تعديل. مثلاً:

useMutation(createTransfer, {
  onSuccess: (newTransfer) => {
    // حفظ القيمة في الجدول الرئيسي تم بنجاح
    saveAutocompleteValue('senderNames', newTransfer.senderName);
    saveAutocompleteValue('transferNumbers', newTransfer.transferNumber);
    // ... وهكذا لبقية الحقول
  }
});


3. تكرار نفس النهج لعمليات الإضافة الخاصة بالعهد والمواصلات وغيرها من الأقسام التي تستخدم الـ autocomplete.


4. اختبار بعد التعديل: إدخال قيمة جديدة لأي من الحقول المذكورة، الضغط على “إضافة” ثم التأكد من ظهور القيمة في قائمة الاقتراحات في المحاولة التالية.




---

باتباع هذا الأسلوب، ستضمن أن جميع القيم التي يُدخلها المستخدم تُضاف تلقائياً إلى جدول autocomplete_data مهما كانت طريقة الإدخال، وليس فقط عند اختيار القائمة المنسدلة أو التعامل مع الأحداث الجزئية.

